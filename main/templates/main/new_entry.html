{% extends 'base.html'  %}

{% block head %}
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
    $(document).ready(function(){
            var error_list;

            $("<br/><a href=\"#add-more-error\" id=\"id_add_more\">Add more errors</a>").insertAfter("#id_form-0-etype");
            $("#id_form-0-etype").addClass("error_types");

            $.getJSON('/get-error-types/',function(data) {
                error_list = data;
                //alert('Fetched ' + error_list.length + ' items!');
                });
            $(".error_types").live('change', function (){
                $(".sub_errors").remove();
                sel_error = parseInt($(this).val());
                if(isNaN(sel_error) == false){
                var output = "&nbsp;&nbsp;"
                output += "<select class=\"sub_errors\" level=\"1\" id=\"id_sub_errors_1\">";
                output += "<option value=\"\" selected=\"selected\">------------</option>";
                for(i = 0; i < error_list.length; i++ ){
                if (error_list[i].fields.parent == sel_error){
                output += "<option value=\"" + error_list[i].pk + "\">" + error_list[i].fields.name + "</option>";
                }
                }
                output += "</select>&nbsp;&nbsp;";
                $(output).insertAfter($(this));
                }
                });
            $(".sub_errors").live('change', function (){
                    var sel_sub_error = parseInt($(this).val());
                    var temp = String(jQuery(this).get(0).id).split("_");
                    var level = String(jQuery(this).get(0).id).split("_")[3];
                    var child_count = 0;
                    if(isNaN(sel_sub_error) == false){
                    level = parseInt(level) + 1;
                    $(".sub_errors").each(function() {
                        if(parseInt(String(jQuery(this).get(0).id).split("_")[3])>= level){
                        $(this).remove();
                        }
                        });
                    var output = "&nbsp;&nbsp;"
                    output += "<select class=\"sub_errors\" level=\"" + level + "\" id=\"id_sub_errors_" + level + "\">";
                    output += "<option value=\"\" selected=\"selected\">------------</option>";
                    for(i = 0; i < error_list.length; i++ ){
                    if (error_list[i].fields.parent == sel_sub_error){
                    child_count += 1;
                    output += "<option value=\"" + error_list[i].pk + "\">" + error_list[i].fields.name + "</option>";
                    }
                    }
                    output += "</select>&nbsp;&nbsp;";
                    if (child_count > 0){
                    $(output).insertAfter($(this));
                    }   
                    }
            });
           $("#id_add_more").live('click',function(e){
                    e.preventDefault();
                    $("#id_add_more").remove();
                    clone_details = $(".error_types:last").clone();
                    $(".error_types:last").parent().append(clone_details);
                    $("<br/><a href=\"#add-more-error\" id=\"id_add_more\">Add more errors</a>").insertAfter(".error_types:last");
            });
    });
</script>
{% endblock %}

{% block content %}
<fieldset class="module aligned ">
{% for field in uid_status_form %}
    <div class="form-row">
            <div class="field-box">
                {{ field.errors }}
                {{ field.label_tag }}: {{ field }}
            </div>
    </div>
{% endfor %}
</fieldset>

<fieldset class="module aligned ">
<h2>Errors</h2>
<table>
     <tr>
     {% for field in uid_error_formset.forms.0 %}
          {% if not field.is_hidden %}
               <th>{{ field.label }}</th>
          {% endif %}
     {% endfor %}
     </tr>
     {% for f in uid_error_formset.management_form %}
          {{ f }}
     {% endfor %}
     {% for f in uid_error_formset.forms %}
          <tr>
          {% for field in f %}
               {% if not field.is_hidden %}
                    <td>
                    {{ field.errors }}
                    {{ field }}
                    </td>
               {% else %}
                    <td valign="bottom">{{ field }}</
               {% endif %}
          {% endfor %}
          </tr>
     {% endfor %}
</table>
</fieldset>

{% endblock %}
