{% extends 'base.html' %}
{% block head %}
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"
    type="text/javascript"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.13/jquery-ui.min.js"
    type="text/javascript"></script>
<script type="text/javascript">
    $(document).ready(function(){
            $('#date').datepicker({dateFormat:'yy-mm-dd', inline:true});
            var index = 0;
            var error_types = new Array();
            var error_list;
               $.getJSON('/get-error-types/', function(data){
               error_list = data;
               for(i=0; i<error_list.length;i++){
               if(error_list[i].fields.level == 0)
               error_types.push(error_list[i]);
               }

               $(".error_types").each(function(){
                   $(this).val(error_types[index].pk);
                   var output1 = '';
                   output1 += '<strong>'+error_types[index].fields.name + '</strong>&nbsp;&nbsp';
                   var output = '';
                   output += "<select class=\"sub_errors\" level=\"1\"";
                   output += "id=\"id_sub_errors_1\" form_id=\"";
                   output += jQuery(this).get(0).id + "\">";
                   output += "<option value=\"\" selected=\"selected\">";
                   output += "------------</option>";
                   var child_count = 0;
                   for (i = 0; i < error_list.length; i++) {
                   if (error_list[i].fields.parent == error_types[index].pk) {
                   output += "<option value=\"" + error_list[i].pk +
                   "\">" + error_list[i].fields.name + "</option>";
                   child_count += 1;
                   }
                   }
                   output += "</select>&nbsp;&nbsp;";
                   if (child_count > 0)
                   $('<td>' + output1 + output + '</td>').insertBefore($(this).parent());
                   else
                       $('<td>'+output1+'</td>').insertBefore($(this).parent());
                   index += 1;
                   });

               });
               $(".sub_errors").live('change', function(){
                       sel_sub_error_form_id = $(this).attr("form_id");
                       sel_sub_error = parseInt($(this).val());
                       level = jQuery(this).attr("level");
                       child_count = 0;
                       $('.error_types').each(function(){
                           if ($(this).get(0).id == sel_sub_error_form_id)
                           $(this).val(sel_sub_error);
                           });
                       if (isNaN(sel_sub_error) == false) {
                       level = parseInt(level) + 1;
                       $(".sub_errors").each(function(){
                           if (parseInt(jQuery(this).attr("level")) >= level) {
                           if(String(jQuery(this).attr("form_id")) == String(
                                   sel_sub_error_form_id))
                           $(this).remove();
                           }
                           });
                       var output = "&nbsp;&nbsp;"
                       output += "<select class=\"sub_errors\" level=\"" +
                       level + "\" id=\"id_sub_errors_" + level +
                       "\" form_id=\"" + sel_sub_error_form_id + "\">";
                       output += "<option value=\"\" selected=\"selected\">" +
                       "------------</option>";
                       for (i = 0; i < error_list.length; i++) {
                           if (error_list[i].fields.parent == sel_sub_error) {
                               child_count += 1;
                               output += "<option value=\"" + error_list[i].pk +
                                   "\">" + error_list[i].fields.name + "</option>";
                           }
                       }
                       output += "</select>&nbsp;&nbsp;";
                       if (child_count > 0) {
                           $(output).insertAfter($(this));
                       }
                       }
               });
    });
</script>
<link rel='stylesheet' href="{{ STATIC_URL }}css/jquery-ui-1.8.13.custom.css" type = "text/css"/>
{% endblock %}
{% block content %}
<h3>Add Uncompleted Surveys</h3>
<form action="" method="post" id="entry_form">
    {{ error_formset.management_form }}
    <table>
        <tr>
            <th>Name of Surveyor:</th>
            <td>{{ role.name }}</td>
        </tr>
        <tr>
            <th>Date of completion:</th>
            <td><input type="text" name="date" value="{{ date|date:"Y-m-j" }}" id="date"></td>
        </tr>
        {{ uid_form.as_table }}
        {{ error_formset.non_form_errors.as_ul }}
        {% for form in error_formset %}
        <tr>
            {% for field in form.visible_fields %}
            <th>{{ field.label }}:</th>
            <td>
                {# Include the hidden fields in the form #}
                {% if forloop.first %}
                {% for hidden in form.hidden_fields %}
                {{ hidden }}
                {% endfor %}
                {% endif %}
                {{ field.errors.as_ul }}
                {{ field }}
            </td>
            {% endfor %}
            {% endfor %}
            <tr class="no-border"><td><input type="submit" value="Submit" /></td><td>{% csrf_token %}</td></tr>
        </table>
    </form>
    {% endblock %}
