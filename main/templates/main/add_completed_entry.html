{% extends 'base.html' %}
{% block head %}
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.13/jquery-ui.min.js"
    type="text/javascript"></script>
<script src="{{ STATIC_URL }}js/validate_date.js" type="text/javascript"></script>
<script type="text/javascript">
    $(document).ready(function(){
            var role_id = {{ role.id }};
            var questions;
            var choices;
            var uid_list = new Array();

            var output = '<input type="hidden" name="date" class="hidden_date" value="'+$('#date').val()+'"></input>';
            $(output).insertBefore('.uid');

            $('#date').live('change', function(){
                var d=$(this).val();
                $('.hidden_date').each(function(){
                    $(this).val(d);
                    });
                });
            $('.add-row').click(function(){
                output = '<br/><form action="" method="post" class="entry_form">';
                output += $('.entry_form:first').clone().html();
                output += '</form><br/>';
                $(output).insertBefore($(this));
                });

            $.getJSON('/get-choices/'+role_id, function(data){
                choices = data;
                $.getJSON('/get-questions/'+role_id, function(data){
                    questions = data;
                    var index=0;
                    $('.question').each(function(){
                        output = '<tr><th>' + questions[index].fields.name + '</th></tr>';
                        $(output).insertAfter($(this));
                        output = '<option value="" selected="selected">---------</option>';
                        for(i=0;i<choices.length;i++){
                        if(choices[i].fields.question==questions[index].pk)
                        output += '<option value="'+choices[i].pk+'">'+choices[i].fields.name+'</option>';
                        }
                        $(this).siblings('.choice').html(output);
                        $(this).val(questions[index].pk);
                        index += 1;
                        });
                    });
                });

            $.getJSON('/get-uid-list/'+role_id, function(data){
                    for(i=0;i<data.length;i++){
                    uid_list.push(String(data[i].fields.uid));
                    }
                    $(".uid").each(function(){
                        $(this).autocomplete({source: uid_list});
                        });
                    });


            $('#date').datepicker({dateFormat:'yy-mm-dd', inline:true});
            $('#date').live('change', function(){
                    if(isDate($(this).val())==false){
                    $(this).focus();
                    return false;
                    }
                    return true;
                    });
            $("#entry_form").submit(function(e){
                    if(isDate($('#date').val())==false){
                    e.preventDefault();
                    return false;
                    }
                    return true;
                    });

    });
</script>
<link rel='stylesheet' href="{{ STATIC_URL }}css/jquery-ui-1.8.13.custom.css" type = "text/css"/>
{% endblock %}
{% block content %}
<h3>Add Completed Surveys</h3>
<table>
    <tr>
        <th>Name of Surveyor:</th>
        <td>{{ role.name }}</td>
    </tr>
    <tr>
        <th>Date of completion:</th>
        <td><input type="text" name="date" value="{{ date|date:"Y-m-j" }}" id="date"></td>
    </tr>
</table>
<form action="" method="post" class="entry_form">
    {{ formset.management_form }}
    <table border="1">
        {{ formset.non_form_errors.as_ul }}
        {% for field in uid_form %}
        <th>{{ field.label }} : </th>
        <td>
            {% if forloop.first %}
            {% for hidden in form.hidden_fields %}
            {{ hidden }}
            {% endfor %}
            {% endif %}
            {{ field }}
        </td>
        {% endfor %}
        {% for form in formset %}
        <td>
            <table>
                {% for field in form.visible_fields %}
                <tr><td>
                        {# Include the hidden fields in the form #}
                        {% if forloop.first %}
                        {% for hidden in form.hidden_fields %}
                        {{ hidden }}
                        {% endfor %}
                        {% endif %}
                        {{ field.errors.as_ul }}
                        {{ field }}
                </td></tr>
                {% endfor %}
            </table>
        </td>
        {% endfor %}
        <td><input type="submit" value="Submit" /></td>
        {% csrf_token %}
    </table>
</form>
<a href="javascript:void(0)" class="add-row">
    <img src="{{ STATIC_URL }}admin/img/admin/icon_addlink.gif" title="Add another form"/>
</a>
{% endblock %}
